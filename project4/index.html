<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentiment & Emotion Lab | Data Lab</title>
    <link rel="stylesheet" href="../assets/site.css">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <style>
        .nlp-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-card {
            padding: 24px;
        }

        textarea {
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        textarea:focus {
            border-color: var(--primary);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .emotion-bar-container {
            margin-bottom: 12px;
        }

        .emotion-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .bar-bg {
            height: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width 0.3s ease-out;
            box-shadow: 0 0 10px var(--primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
        }

        .status-badge.ready {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .status-badge.loading {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .sentiment-overlay {
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            background: rgba(167, 139, 250, 0.05);
            border: 1px solid rgba(167, 139, 250, 0.1);
        }

        .sentiment-score {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            background: linear-gradient(to bottom, #fff, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body data-lab-name="Data Lab" data-page-name="Sentiment & Emotion" data-home="../index.html">
    <div class="container">
        <header>
            <div class="header-content">
                <a href="../index.html" class="back-link">
                    <i data-lucide="arrow-left"></i> Back to Hub
                </a>
                <h1 data-i18n="title">Sentiment & Emotion Analysis</h1>
                <p class="subtitle" data-i18n="subtitle">Real-time NLP processing using quantized BERT transformers
                    directly in your browser.</p>
            </div>
        </header>

        <div class="nlp-container">
            <!-- Model Status -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div id="modelStatus" class="status-badge loading">
                    <i data-lucide="refresh-cw" class="spin"></i> <span data-i18n="loading">Initializing AI
                        Model...</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-light);">
                    BERT-Tiny (Int8) • WebAssembly/WebGPU
                </div>
            </div>

            <div class="card input-card">
                <div class="card-header">
                    <i data-lucide="message-square"></i> <span data-i18n="input">Text Input</span>
                </div>
                <textarea id="textInput" placeholder="Type something to analyze its emotional tone..." maxlength="2000"
                    disabled></textarea>
                <div
                    style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-light);">
                    <span><i data-lucide="shield-check" style="width: 12px; margin-right: 4px;"></i> Privacy Note: 100%
                        local processing.</span>
                    <span id="charCount">0 / 2000</span>
                </div>
            </div>

            <div class="results-grid">
                <!-- Emotions -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="activity"></i> <span data-i18n="emotions">Emotional Spectrum</span>
                    </div>
                    <div id="emotionsList">
                        <!-- Bars will be injected here -->
                    </div>
                </div>

                <!-- Sentiment -->
                <div class="card">
                    <div class="card-header">
                        <i data-lucide="bar-chart-3"></i> <span data-i18n="sentiment">Dominant Sentiment</span>
                    </div>
                    <div class="sentiment-overlay">
                        <div id="sentimentLabel" style="font-size: 1.1rem; color: var(--text-light);">No data</div>
                        <div id="sentimentValue" class="sentiment-score">0%</div>
                        <div id="sentimentBar" class="bar-bg" style="width: 80%; margin: 10px auto;">
                            <div class="bar-fill" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        const translations = {
            en: {
                title: 'Sentiment & Emotion Analysis',
                subtitle: 'Real-time NLP processing using quantized BERT transformers directly in your browser.',
                loading: 'Initializing AI Model...',
                ready: 'AI Neural Engine Ready',
                input: 'Text Input',
                emotions: 'Emotional Spectrum',
                sentiment: 'Dominant Sentiment'
            },
            pl: {
                title: 'Analiza Sentymentu i Emocji',
                subtitle: 'Przetwarzanie NLP w czasie rzeczywistym przy użyciu transformatorów BERT bezpośrednio w przeglądarce.',
                loading: 'Inicjalizacja modelu AI...',
                ready: 'Silnik neuronowy AI gotowy',
                input: 'Wprowadzanie tekstu',
                emotions: 'Spektrum emocjonalne',
                sentiment: 'Dominujący sentyment'
            }
        };

        const app = {
            lang: 'en',
            classifier: null,
            labels: ["sadness", "joy", "love", "anger", "fear", "surprise"],
            colors: {
                sadness: '#60a5fa', // Blue
                joy: '#fbbf24',    // Amber
                love: '#f472b6',   // Pink
                anger: '#f87171',  // Red
                fear: '#a78bfa',   // Violet
                surprise: '#34d399' // Emerald
            },

            init: async () => {
                app.lang = document.documentElement.getAttribute('lang') || 'en';
                app.updateTranslations();
                window.addEventListener('langchange', (e) => {
                    app.lang = e.detail.lang;
                    app.updateTranslations();
                });

                app.initEmotionsList();

                try {
                    // Configure transformers.js
                    env.allowLocalModels = true;
                    env.allowRemoteModels = false;
                    env.localModelPath = '../project4/models/';

                    // Load pipeline
                    // 'emotion' is the folder name in models/
                    app.classifier = await pipeline('text-classification', 'emotion', {
                        device: 'auto',
                    });

                    app.onReady();
                } catch (err) {
                    console.error("Model loading failed:", err);
                    document.getElementById('modelStatus').innerHTML = '<i data-lucide="alert-circle"></i> Failed to load model.';
                    document.getElementById('modelStatus').classList.remove('loading');
                    document.getElementById('modelStatus').style.color = 'var(--error)';
                    lucide.createIcons();
                }

                document.getElementById('textInput').addEventListener('input', (e) => {
                    const text = e.target.value;
                    document.getElementById('charCount').textContent = `${text.length} / 2000`;
                    app.debounce(app.analyze, 300)(text);
                });
            },

            updateTranslations: () => {
                const t = translations[app.lang] || translations.en;
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (t[key]) el.textContent = t[key];
                });
            },

            initEmotionsList: () => {
                const container = document.getElementById('emotionsList');
                container.innerHTML = '';
                app.labels.forEach(label => {
                    const div = document.createElement('div');
                    div.className = 'emotion-bar-container';
                    div.innerHTML = `
                        <div class="emotion-label">
                            <span style="text-transform: capitalize;">${label}</span>
                            <span id="score-${label}">0%</span>
                        </div>
                        <div class="bar-bg">
                            <div id="bar-${label}" class="bar-fill" style="background: ${app.colors[label]}; box-shadow: 0 0 10px ${app.colors[label]}88;"></div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            onReady: () => {
                const status = document.getElementById('modelStatus');
                status.classList.remove('loading');
                status.classList.add('ready');
                const t = translations[app.lang] || translations.en;
                status.innerHTML = `<i data-lucide="check-circle"></i> <span>${t.ready}</span>`;
                lucide.createIcons();

                const input = document.getElementById('textInput');
                input.disabled = false;
                input.focus();
            },

            analyze: async (text) => {
                if (!text || text.trim().length === 0) {
                    app.clearResults();
                    return;
                }

                try {
                    // Truncate for model safety and performance
                    const truncated = text.slice(0, 512);
                    const results = await app.classifier(truncated, { topk: 6 });

                    // Sort by score for dominant
                    const sorted = [...results].sort((a, b) => b.score - a.score);
                    const dominant = sorted[0];

                    // Update dominant UI - ensure text content is sanitized
                    const labelEl = document.getElementById('sentimentLabel');
                    labelEl.textContent = dominant.label.toUpperCase();

                    document.getElementById('sentimentValue').textContent = Math.round(dominant.score * 100) + '%';

                    const barFill = document.querySelector('#sentimentBar .bar-fill');
                    barFill.style.width = (dominant.score * 100) + '%';
                    barFill.style.background = app.colors[dominant.label];
                    barFill.style.boxShadow = `0 0 15px ${app.colors[dominant.label]}`;

                    // Update spectrum
                    results.forEach(res => {
                        const perc = Math.round(res.score * 100);
                        const scoreEl = document.getElementById(`score-${res.label}`);
                        if (scoreEl) scoreEl.textContent = perc + '%';

                        const barEl = document.getElementById(`bar-${res.label}`);
                        if (barEl) barEl.style.width = perc + '%';
                    });
                } catch (err) {
                    console.warn("Inference interrupted or failed:", err);
                }
            },

            clearResults: () => {
                document.getElementById('sentimentLabel').textContent = 'No data';
                document.getElementById('sentimentValue').textContent = '0%';
                document.querySelector('#sentimentBar .bar-fill').style.width = '0%';
                app.labels.forEach(label => {
                    document.getElementById(`score-${label}`).textContent = '0%';
                    document.getElementById(`bar-${label}`).style.width = '0%';
                });
            },

            debounce: (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }
        };

        window.onload = app.init;
    </script>
    <script src="../assets/site.js"></script>
</body>

</html>